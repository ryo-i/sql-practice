### インデックス（何に・なぜ貼るか）

```
sql_practice=# \i basic/13_index_basic.sql
 id |       title        |     name     
----+--------------------+--------------
  1 | 初めての投稿       | Alice Cooper
  2 | Bobの日記          | Bob
  3 | Aliceの2つ目の投稿 | Alice Cooper
(3 rows)

 id |       title        
----+--------------------
  1 | 初めての投稿
  3 | Aliceの2つ目の投稿
(2 rows)

CREATE INDEX
 id |       title        
----+--------------------
  1 | 初めての投稿
  3 | Aliceの2つ目の投稿
(2 rows)

CREATE INDEX
 id |       title        |         created_at         
----+--------------------+----------------------------
  1 | 初めての投稿       | 2026-01-25 22:59:07.128589
  2 | Bobの日記          | 2026-01-25 22:59:07.128589
  3 | Aliceの2つ目の投稿 | 2026-01-25 22:59:07.128589
(3 rows)
```

① インデックスなしで JOIN を使う SELECT

ここで起きていること
- posts と users を user_id = id で結合
- まだ posts.user_id にインデックスはない

DB内部の動き（イメージ）
- posts を1行ずつ読む
- 各行ごとに users を探す
- データが増えると JOIN が重くなる

学習ポイント
- JOIN は「結合キー」にインデックスがないと遅くなりやすい

② WHERE で user_id を絞る（よくあるクエリ）

ここで起きていること
- user_id = 1 の投稿を探す
- インデックスなしなので 全件走査（Seq Scan）

DB内部の動き
- posts を先頭から最後まで全部読む
  - → 条件に合う行だけ返す

学習ポイント
- WHERE 句はインデックスの最重要対象

③ posts.user_id にインデックスを貼る

ここで起きていること
- posts.user_id 用の 索引（検索用の別構造） が作られる
- データ行は一切変わらない

このインデックスが効く場面
- WHERE p.user_id = ?
- JOIN posts.user_id = users.id

学習ポイント
- 「JOINキー + WHERE条件」は最優先でインデックス候補

④ 同じ SELECT をもう一度（結果は変わらない）

見た目の結果
- ②と 完全に同じ

でも内部では？
- Index Scan が使われる可能性が出る
- DBは「インデックス経由で該当行だけ取れるな」と判断できる
- ただし：データが少ないと Seq Scan のまま になることもある

学習ポイント
- インデックスは「結果」ではなく「処理経路」を変える

⑤ created_at にもインデックスを貼ってみる（ORDER BY 用）

ここで起きていること
- created_at の 並び順用インデックス

これは何のため？
- ORDER BY created_at
- 最新順 / 古い順の一覧表示

学習ポイント
- ORDER BY / LIMIT はインデックスがないと激重になりやすい

⑥ 並び替えクエリ
インデックスなしの場合
- 全件取得
- メモリ or ディスクでソート
- 件数が多いとかなり重い

インデックスありの場合
- インデックス順に読むだけ
- ソート不要 or 最小限

学習ポイント
- ORDER BY 用インデックスは「一覧画面の生命線」

まとめ

インデックス名は DB内部で参照されるだけ
- この idx_posts_user_id は 人間が識別する名前
- SELECT 文で明示的に書く必要はありません
- DB が自動で WHERE / JOIN / ORDER BY に使えそうな場合に参照 します

SELECT 文の書き方は変わらない
- ②と④の違いは見た目の結果は同じ
- インデックスがあるかどうかで DB の処理方法が変わる

インデックスの効果

| 効果   | 内容                                     |
| ---- | -------------------------------------- |
| 結果   | **変わらない**                              |
| 実行速度 | **変わる**                                |
| 実行計画 | `EXPLAIN` で Seq Scan → Index Scan に変わる |

- 例えば posts.user_id にインデックスがあれば、WHERE user_id = 1 は Index Scan になり、全件スキャン（Seq Scan）より速くなる
- ORDER BY created_at もインデックスがあれば ソート処理が減る
- ただし結果は常に同じ

